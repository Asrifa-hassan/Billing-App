{% extends 'navbar.html' %}
{% load static %}
{% block title %}New Invoice{% endblock %}
{% block link %}
<link rel="stylesheet" href="{% static 'css/product.css' %}">
<link rel="stylesheet" href="{% static 'css/invoice.css' %}">
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<style>
    .sticky-summary {
        position: sticky;
        top: 70px;
        background: #fff;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .badge-cart {
        background: #1d4876;
        color: white;
        border-radius: 50%;
        padding: 4px 10px;
        font-size: 12px;
    }
</style>
{% endblock %}
{% block content %}

<div class="col-lg-10 col-md-9 col-sm-9 page-col">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold">üßæ Create New Invoice
                {% if cart_items %}<span class="badge-cart">{{ cart_items|length }}</span>{% endif %}
            </h3>
            <a href="{% url 'invoices' %}" class="btn btn-outline-secondary btn-sm"><< Back </a>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <div class="bg-white new-invoice shadow-sm rounded p-4">

                    <!-- Customer Section -->
                    <div class="customer-details mb-4">
                        <h4>üë§ Customer Information</h4>
                        <hr>
                        {% if customer %}
                            <p><strong>Name:</strong> {{ customer.fullname }}</p>
                            <p><strong>Phone:</strong> +91 {{ customer.phone }}</p>
                            <p><strong>Address:</strong> {{ customer.address }}</p>
                        {% else %}
                            <div class="btn-group mt-3">
                                <button class="btn btn-primary" onclick="new_customer()">‚ûï New Customer</button>
                                <button class="btn btn-info" onclick="existing_customer()">üîç Existing</button>
                            </div>
                        {% endif %}

                        <!-- New Customer Form -->
                        <div id="new-customer-div" class="p-3 mt-3 border rounded bg-light" style="display:none;">
                            <form action="{% url 'new_customer' %}" method="post">
                                {% csrf_token %}
                                <input type="text" name="fullname" placeholder="Fullname" class="form-control mb-2" required>
                                <input type="tel" name="phone" class="form-control mb-2" placeholder="Phone" minlength="10" maxlength="10" required>
                                <textarea name="address" class="form-control mb-2" placeholder="Address"></textarea>
                                <button class="btn btn-success w-100" style="background-color: #1d4876">üíæ Save</button>
                            </form>
                        </div>

                        <!-- Existing Customer Search -->
                        <div id="existing-customer-div" class="p-3 mt-3 border rounded bg-light" style="display:none;">
                            <input type="text" id="customerSearch" class="form-control" placeholder="Search by phone">
                            <div id="dropdownList" class="list-group mt-1"></div>
                        </div>
                    </div>

                    <!-- Product Search -->
                    <div class="product-search mb-4">
                        <h4>üì¶ Product Search</h4>
                        <input type="text" id="productSearch" class="form-control mt-2" placeholder="Search product">
                        <div id="productDropdown" class="list-group mt-1"></div>
                    </div>

                    <!-- Cart Items Table -->
                    <div class="scroll-table mb-4">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th><th>Product</th><th>Qty</th><th>Price</th><th>Sub Total</th>
                                </tr>
                            </thead>
                            <tbody id="product-items">
                                {% for i in cart_items %}
                                    <tr>
                                        <td>
                                            <form method="post">{% csrf_token %}
                                                <input type="hidden" name="action" value="remove_product">
                                                <input type="hidden" name="product_id" value="{{ i.id }}">
                                                <button class="btn btn-danger btn-sm"><i class="fa fa-trash"></i></button>
                                            </form>
                                        </td>
                                        <td>{{ i.product.name }}</td>
                                        <td>
                                            <form method="post">{% csrf_token %}
                                                <input type="hidden" name="action" value="update_quantity">
                                                <input type="hidden" name="item_id" value="{{ i.id }}">
                                                <input type="number" name="quantity" class="form-control form-control-sm"
                                                       value="{{ i.quantity }}" min="1" max="{{ i.product.stock }}" onchange="this.form.submit();">
                                            </form>
                                        </td>
                                        <td>{{ i.product.price }}</td>
                                        <td>{{ i.sub_total }}</td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center text-muted">No items added yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Invoice Notes -->
                    <div class="mb-3">
                        <label>üìù Invoice Notes (Optional):</label>
                        <textarea class="form-control" name="notes" placeholder="Add notes..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column (Sticky Summary) -->
            <div class="col-lg-4">
                <div class="sticky-summary">
                    {% if cart %}
                        <form method="post">{% csrf_token %}
                            <input type="hidden" name="action" value="payment">
                            <label>üí∞ Amount Paid:</label>
                            <input type="number" step="0.01" name="amount_paid" value="{{ cart.amount_paid }}" class="form-control mb-2">
                            <label>üí≥ Payment Method:</label>
                            <select name="payment_method" class="form-select mb-2">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="wallet">Wallet</option>
                            </select>
                            <label>üéüÔ∏è Discount (%)</label>
                            <input type="number" id="discount" name="discount" class="form-control mb-2" placeholder="Enter discount" oninput="calculateGrandTotal()">
                            <button class="btn btn-success w-100 mb-3" style="background-color: #1d4876">Record Payment</button>
                        </form>

                        <div class="border p-3 rounded bg-light mb-3">
                            <p><strong>Total:</strong> ‚Çπ{{ cart.total }}</p>
                            <p><strong>Tax ({{ cart.gst_percentage }}%):</strong> ‚Çπ{{ cart.gst }}</p>
                            <p><strong>Grand Total:</strong> ‚Çπ<span id="grandTotal">{{ cart.grand_total }}</span></p>
                            <p><strong>Due:</strong> ‚Çπ{{ due_amount }}</p>
                            <p><strong>Balance:</strong> ‚Çπ{{ balance }}</p>
                            <p><strong>Wallet:</strong> ‚Çπ{{ customer.wallet }}</p>
                        </div>

                        <div class="d-flex gap-2">
                            <form method="post" class="flex-fill">{% csrf_token %}
                                <input type="hidden" name="action" value="clear_invoice">
                                <button class="btn btn-outline-danger w-100">üßπ Clear</button>
                            </form>
                            <form method="post" class="flex-fill">{% csrf_token %}
                                <input type="hidden" name="action" value="save_invoice">
                                <button class="btn btn-primary w-100" style="background-color: #1d4876">üíæ Save Invoice</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="{% static 'js/invoice.js' %}"></script>
<script>
function calculateGrandTotal() {
    let discount = parseFloat(document.getElementById('discount').value || 0);
    let originalTotal = parseFloat({{ cart.grand_total|default:0 }});
    let discountedTotal = originalTotal - (originalTotal * (discount / 100));
    document.getElementById('grandTotal').innerText = discountedTotal.toFixed(2);
}
</script>

<script>
// --- Customer Search ---
const searchinput = document.getElementById('customerSearch');
const dropdown = document.getElementById('dropdownList');
searchinput.addEventListener('input', function () {
    const query = this.value;
    if (query.length < 1) {
        dropdown.innerHTML = '';
        return;
    }
    fetch(`/search_customer?q=${query}`)
        .then(res => res.json())
        .then(data => {
            dropdown.innerHTML = '';
            data.forEach(customer => {
                const div = document.createElement('a');
                div.className = 'list-group-item list-group-item-action';
                div.textContent = `${customer.fullname} - ${customer.phone}`;
                div.href = '#';
                div.addEventListener('click', function (e) {
                    e.preventDefault();
                    fetch('/create_invoice/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({ phone: customer.phone })
                    }).then(() => {
                        window.location.href = '/create_invoice/';
                    });
                });
                dropdown.appendChild(div);
            });
        });
});

// --- Product Search ---
const searchInput = document.getElementById('productSearch');
const productDropdown = document.getElementById('productDropdown');
searchInput.addEventListener('input', function () {
    const query = this.value;
    if (query.length < 1) {
        productDropdown.innerHTML = '';
        return;
    }
    fetch(`/search_product?q=${query}`)
        .then(res => res.json())
        .then(data => {
            productDropdown.innerHTML = '';
            data.forEach(product => {
                const div = document.createElement('button');
                div.type = 'button';
                div.className = 'list-group-item list-group-item-action text-start';
                div.textContent = product.name;
                div.addEventListener('click', function () {
                    fetch(`/add_to_cart/${product.id}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({})
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert(data.message || "Failed to add product.");
                        }
                    });
                });
                productDropdown.appendChild(div);
            });
        })
        .catch(err => console.error("Error fetching products:", err));
});

// --- CSRF helper ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.split('=')[1]);
                break;
            }
        }
    }
    return cookieValue;
}

// --- Toggle ---
function existing_customer(){
    document.getElementById("existing-customer-div").style.display = "block";
    document.getElementById("new-customer-div").style.display = "none";
}
function new_customer(){
    document.getElementById("new-customer-div").style.display = "block";
    document.getElementById("existing-customer-div").style.display = "none";
}
</script>
{% endblock %}
