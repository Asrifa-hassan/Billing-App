{% extends 'navbar.html' %}
{% load static %}

{% block title %}Edit Invoice #{{ invoice.id }}{% endblock %}

{% block link %}
<link rel="stylesheet" href="{% static 'css/invoice.css' %}">
<style>
.sticky-summary {
    position: sticky;
    top: 70px;
    background: #fff;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.badge-cart {
    background: #1d4876;
    color: white;
    border-radius: 50%;
    padding: 4px 10px;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="col-lg-10 col-md-9 col-sm-9 page-col">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>üßæ Edit Invoice #{{ invoice.id }}</h3>
            <a href="{% url 'invoices' %}" class="btn btn-outline-secondary btn-sm"><< Back </a>
        </div>
        <div class="row">
            <!-- Left Column: Customer & Invoice Details -->
            <div class="col-lg-8">
                <div class="bg-white shadow-sm rounded p-4 mb-4">
                    <!-- Customer Edit Form -->
                    <h4>üë§ Customer Information</h4>
                    <hr>
                    <form method="post" action="{% url 'edit_invoice' invoice.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="edit_customer">
                        <div class="mb-2">
                            <input type="text" name="fullname" class="form-control" value="{{ customer.fullname }}" required>
                            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
                            <textarea name="address" class="form-control">{{ customer.address }}</textarea>
                        </div>
                    </form>

                    <!-- Invoice Items Table -->
                    <h4>üì¶ Invoice Items</h4>
                    <div class="scroll-table">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ item.product.name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>‚Çπ{{ item.price }}</td>
                                        <td>‚Çπ{{ item.subtotal }}</td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center text-muted">No items in this invoice.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Notes Form -->
                    <h4 class="mt-3">üìù Notes</h4>
                    <form method="post" action="{% url 'edit_invoice' invoice.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save_invoice">
                        <textarea class="form-control mb-2" name="notes" placeholder="Add notes...">{{ invoice.notes }}</textarea>
                    </form>
                </div>
            </div>

            <!-- Right Column: Payment & Summary -->
            <div class="col-lg-4">
                <div class="sticky-summary">
                    <h4>üí∞ Record Payment</h4>
                    <form method="post" action="{% url 'edit_invoice' invoice.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="payment">
                        <label>Amount Paid:</label>
                        <input type="number" step="0.01" min="0" name="amount_paid" class="form-control mb-2" value="0">

                        <label>Payment Method:</label>
                        <select name="payment_method" class="form-select mb-2">
                            <option value="cash" {% if invoice.payment_method|default:"cash" == "cash" %}selected{% endif %}>Cash</option>
                            <option value="card" {% if invoice.payment_method|default:"cash" == "card" %}selected{% endif %}>Card</option>
                            <option value="wallet" {% if invoice.payment_method|default:"cash" == "wallet" %}selected{% endif %}>Wallet</option>
                        </select>

                        <button type="submit" class="btn btn-success" style="background-color:#1d4876; width:60%;">Record Payment</button>
                    </form>

                    <!-- Invoice Summary -->
                    <div class="border p-3 rounded bg-light">
                        <p><strong>Total:</strong> ‚Çπ{{ invoice.total }}</p>
                        <p><strong>GST:</strong> ‚Çπ{{ invoice.grand_total|floatformat:2|add:"-invoice.total" }}</p>
                        <p><strong>Grand Total:</strong> ‚Çπ{{ invoice.grand_total }}</p>
                        <p><strong>Amount Paid:</strong> ‚Çπ{{ invoice.amount_paid }}</p>
                        <p><strong>Due:</strong> ‚Çπ{{ invoice.amount_due }}</p>
                    </div>

                    <form method="post" action="{% url 'edit_invoice' invoice.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="save_invoice">
                        <button type="submit" class="btn btn-success" style="background-color:#1d4876; width:60%;">üíæ Update Invoice</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
